name: CD Pipeline
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  deploy-to-registry:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Test Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: test-img:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Runtime Validation (Smoke Test)
        run: |
          docker run -d -p 8080:8080 --name test-app test-img:latest
          sleep 20
          curl --retry 5 --retry-delay 3 --retry-connrefused --fail http://localhost:8080/ || exit 1
          docker stop test-app && docker rm test-app

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Images
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            siddharthbaleja/advanced-app:latest
            siddharthbaleja/advanced-app:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Kubernetes Deployment
  deploy-to-kubernetes:
    needs: deploy-to-registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: cicd-cluster
          wait: 60s

      - name: Verify Kubernetes Cluster
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo ""
          echo "=== Nodes ==="
          kubectl get nodes

      - name: Pull and Load Docker Image
        run: |
          docker pull siddharthbaleja/advanced-app:${{ github.sha }}
          kind load docker-image siddharthbaleja/advanced-app:${{ github.sha }} --name cicd-cluster

      - name: Update Deployment Manifest
        run: |
          sed -i "s|image: siddharthbaleja/advanced-app:latest|image: siddharthbaleja/advanced-app:${{ github.sha }}|g" k8s/deployment.yaml
          sed -i "/image: siddharthbaleja/a\          imagePullPolicy: IfNotPresent" k8s/deployment.yaml || true

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for Deployment
        run: |
          kubectl rollout status deployment/advanced-app --timeout=300s

      - name: Verify Deployment
        run: |
          echo "=== Deployments ==="
          kubectl get deployments
          echo ""
          echo "=== Pods ==="
          kubectl get pods -o wide
          echo ""
          echo "=== Services ==="
          kubectl get services
          echo ""
          echo "=== Application Logs ==="
          kubectl logs -l app=advanced-app --tail=30

      - name: Test Application in Kubernetes
        run: |
          kubectl port-forward service/advanced-app-service 8080:8080 &
          sleep 15
          curl --retry 10 --retry-delay 3 --retry-connrefused --fail http://localhost:8080/
          echo "âœ… Kubernetes deployment successful!"

  #  DAST Scan
  dast-scan:
    needs: deploy-to-kubernetes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: dast-cluster
          wait: 60s

      - name: Deploy Application
        run: |
          docker pull siddharthbaleja/advanced-app:${{ github.sha }}
          kind load docker-image siddharthbaleja/advanced-app:${{ github.sha }} --name dast-cluster
          sed -i "s|image: siddharthbaleja/advanced-app:latest|image: siddharthbaleja/advanced-app:${{ github.sha }}|g" k8s/deployment.yaml
          sed -i "/image: siddharthbaleja/a\          imagePullPolicy: IfNotPresent" k8s/deployment.yaml || true
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/advanced-app --timeout=300s

      - name: Port Forward for DAST
        run: |
          kubectl port-forward service/advanced-app-service 8080:8080 &
          sleep 15
          curl --retry 5 --fail http://localhost:8080/

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:8080/'
          cmd_options: '-a'
        continue-on-error: true

      - name: Upload DAST Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-dast-results
          path: report_html.html
          retention-days: 7